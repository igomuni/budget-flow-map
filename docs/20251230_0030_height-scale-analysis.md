# ノード高さスケールの分析

## 背景

閾値設定UIを試験実装した際、「100億円と1000億円のノードの高さに10倍の差が感じられない」という観察があった。
これは実装のバグではなく、**日本政府予算の金額レンジが極めて広い**ことに起因する本質的な特性である。

この分析の結果、**閾値設定UIは廃止**し、固定閾値（1兆円）を採用することを決定した。

## 金額レンジの分析

### 日本政府予算の金額レンジ

| レベル | 例 | 金額 |
|--------|-----|------|
| 最大（府省） | 厚生労働省 | 約93兆円 |
| 大規模局 | 年金局、医政局 | 数兆〜数十兆円 |
| 中規模局 | 一般的な局 | 数千億円 |
| 大規模事業 | 年金給付 | 数兆円 |
| 中規模事業 | 一般的な事業 | 数百億円 |
| 小規模事業 | 小規模事業 | 数億〜数十億円 |
| 最小 | 個別支出先 | 数万円〜 |

**レンジ幅: 約10桁（10^10倍）**

## 高さ計算ロジック（最終版）

```typescript
const HEIGHT_SCALE = 1e-11 // 1兆円 = 10px
const MIN_NODE_HEIGHT = 1 // 閾値以下のノード
const MIN_OTHER_NODE_HEIGHT = 3 // 「その他」ノードの最小高さ

// 動的閾値: ズームレベルに応じて変化
// zoom=0 → 1兆円、zoom=1 → 2500億円、zoom=2 → 625億円...
function getMinVisibleAmount(layer: LayerIndex, zoom: number): number {
  const baseThreshold = 1e12 // 1兆円
  const effectiveZoom = Math.max(0, zoom)
  const reductionFactor = Math.pow(4, effectiveZoom)
  return baseThreshold / reductionFactor
}

function amountToHeight(amount: number, threshold: number, isOther: boolean = false): number {
  if (amount <= 0) return isOther ? MIN_OTHER_NODE_HEIGHT : MIN_NODE_HEIGHT

  // 「その他」ノードは閾値を無視して金額比例
  if (isOther) {
    return Math.max(MIN_OTHER_NODE_HEIGHT, amount * HEIGHT_SCALE)
  }

  // 通常ノード: 閾値以下は最小高さ
  if (amount < threshold) {
    return MIN_NODE_HEIGHT
  }

  // 閾値以上は金額比例（1兆円 = 10px）
  return Math.max(MIN_NODE_HEIGHT, amount * HEIGHT_SCALE)
}
```

### 動的閾値の計算例

| ズーム | 閾値 | 説明 |
|--------|------|------|
| 100% (zoom=0) | 1兆円 | 初期表示 |
| 146% (zoom≈0.55) | 約4691億円 | ズームイン |
| 200% (zoom=1) | 2500億円 | さらにズームイン |
| 400% (zoom=2) | 625億円 | 詳細表示 |

### 高さ計算例（zoom=0.55、閾値≈4691億円の場合）

| 金額 | 閾値比較 | 高さ |
|------|----------|------|
| 1000億円 | 閾値以下 | 1px |
| 4691億円 | 閾値ちょうど | 4.7px |
| 8276億円（埼玉県） | 閾値超え | 8.3px |
| 1.14兆円（児童手当） | 閾値超え | 11.5px |

**重要**: 表示されるノード（閾値超え）は金額に比例した高さになる。
上記例では埼玉県と児童手当の高さ比率（1.39倍）は金額比率と一致する。

### なぜ1兆円=10pxが適切か

1. **全体予算（約150兆円）が1500pxに収まる**
   - 画面高さに収まるサイズで全体俯瞰が可能

2. **主要府省庁が識別可能なサイズになる**
   - 厚労省（93兆円）→ 930px
   - 財務省（35兆円）→ 350px
   - 総務省（20兆円）→ 200px

3. **表示ノードの金額比較が直感的**
   - 動的閾値により、表示されるノードは金額比例の高さを持つ
   - ズームインするほど小さな金額差も視覚的に区別可能

## 設計上の考察

### 現状のスケール（1兆円=10px）の妥当性

**長所:**
- 93兆円（厚労省）が約9330pxで、画面に収まる
- 大規模な予算の違いが視覚的に理解できる
- 全体俯瞰時に破綻しない

**短所:**
- 100億円〜1000億円の違いが視覚的に分かりにくい
- 小規模な予算の比較には不向き

### 代替案の検討

#### 案1: 対数スケール
```typescript
// 対数スケール: log10(金額) に比例
height = log10(amount) * SCALE_FACTOR
```
- 長所: 広いレンジを圧縮できる
- 短所: 直感的でない（10倍の差が一定の高さ差になる）

#### 案2: 平方根スケール
```typescript
// 平方根スケール
height = sqrt(amount) * SCALE_FACTOR
```
- 長所: 対数より直感的
- 短所: まだ大きな金額に偏る

#### 案3: ズームレベル連動スケール
```typescript
// ズームに応じてスケールを変更
const scale = 1e-11 / Math.pow(2, zoom)
```
- 長所: ズームインすると小さな差も見える
- 短所: 実装が複雑、メンタルマップが崩れる可能性

### 固定閾値採用の判断理由

1. **目的との整合性**: このツールの目的は「全体構造の理解」であり、詳細な金額比較ではない
2. **線形スケールの直感性**: 対数スケールは直感的でなく、ユーザーを混乱させる可能性
3. **メンタルマップ保持**: ズーム連動スケールは位置が変わり、認知負荷が増大
4. **大規模予算の可視化**: 主要な府省・局・事業の規模感は十分に伝わる
5. **UI簡素化**: 閾値設定UIはサイズと金額の関係について誤解を招く恐れがあった

## 結論

100億円と1000億円のサイズ差が感じられないのは、**日本政府予算の金額レンジ（10桁）に対して線形スケールを採用しているため**であり、設計上正しい動作である。

このツールは「全体俯瞰」を目的としており、以下のトレードオフを受け入れている:

- **得られるもの**: 93兆円から数億円まで破綻なく描画できる
- **失うもの**: 1兆円未満の金額差の視覚的区別

詳細な金額比較が必要な場合は、InfoPanelのテーブル表示で対応する。

## 最終設定

- **基準閾値**: 1兆円（zoom=0時、ズームに応じて動的に減少）
- **高さスケール**: 1兆円 = 10px
- **閾値以下ノード高さ**: 1px
- **「その他」ノード最小高さ**: 3px
- **表示ノードの高さ**: 金額に比例（動的閾値を使用）

## 関連ファイル

- `src/hooks/useZoomVisibility.ts` - 動的高さ計算
- `scripts/compute-layout.ts` - ビルド時高さ計算
