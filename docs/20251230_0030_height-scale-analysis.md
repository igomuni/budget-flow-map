# ノード高さスケールの分析

## 背景

閾値設定UIを実装した際、「100億円と1000億円のノードの高さに10倍の差が感じられない」という観察があった。
これは実装のバグではなく、**日本政府予算の金額レンジが極めて広い**ことに起因する本質的な特性である。

## 金額レンジの分析

### 日本政府予算の金額レンジ

| レベル | 例 | 金額 |
|--------|-----|------|
| 最大（府省） | 厚生労働省 | 約93兆円 |
| 大規模局 | 年金局、医政局 | 数兆〜数十兆円 |
| 中規模局 | 一般的な局 | 数千億円 |
| 大規模事業 | 年金給付 | 数兆円 |
| 中規模事業 | 一般的な事業 | 数百億円 |
| 小規模事業 | 小規模事業 | 数億〜数十億円 |
| 最小 | 個別支出先 | 数万円〜 |

**レンジ幅: 約10桁（10^10倍）**

### 閾値設定プリセット

| 閾値 | 倍率（10億円基準） |
|------|-------------------|
| 10億円 | 1x |
| 50億円 | 5x |
| 100億円 | 10x |
| 500億円 | 50x |
| 1000億円 | 100x |
| 5000億円 | 500x |
| 1兆円 | 1000x |

## 現在の高さ計算ロジック

```typescript
const HEIGHT_SCALE = 1e-11 // 1兆円 = 10px
const MIN_NODE_HEIGHT = 1   // 閾値以下のノード
const MIN_VISIBLE_HEIGHT = 5 // 閾値以上のノードの最小高さ

function amountToHeight(amount: number, threshold: number): number {
  if (amount < threshold) return MIN_NODE_HEIGHT
  return Math.max(MIN_VISIBLE_HEIGHT, amount * HEIGHT_SCALE)
}
```

### 高さ計算例（閾値100億円の場合）

| 金額 | 計算式 | 高さ |
|------|--------|------|
| 50億円 | 閾値以下 | 1px |
| 100億円 | max(5, 100億 × 1e-11) = max(5, 1) | 5px |
| 500億円 | max(5, 500億 × 1e-11) = max(5, 5) | 5px |
| 1000億円 | max(5, 1000億 × 1e-11) = max(5, 10) | 10px |
| 1兆円 | max(5, 1兆 × 1e-11) = max(5, 100) | 100px |
| 10兆円 | max(5, 10兆 × 1e-11) = max(5, 1000) | 1000px |
| 93兆円（厚労省） | max(5, 93兆 × 1e-11) | 9330px |

## なぜ100億円と1000億円の差が感じられないか

1. **閾値100億円の場合**:
   - 100億円 → 5px（MIN_VISIBLE_HEIGHT）
   - 1000億円 → 10px
   - 差: 2倍（視覚的に小さい）

2. **理論的な10倍の差が出るには**:
   - 両方とも `MIN_VISIBLE_HEIGHT` を超える必要がある
   - 500億円以上のノード同士を比較する必要がある

3. **実際に10倍の差が見える例**:
   - 1000億円（10px）vs 1兆円（100px）→ 10倍
   - 1兆円（100px）vs 10兆円（1000px）→ 10倍

## 設計上の考察

### 現状のスケール（1兆円=10px）の妥当性

**長所:**
- 93兆円（厚労省）が約9330pxで、画面に収まる
- 大規模な予算の違いが視覚的に理解できる
- 全体俯瞰時に破綻しない

**短所:**
- 100億円〜1000億円の違いが視覚的に分かりにくい
- 小規模な予算の比較には不向き

### 代替案の検討

#### 案1: 対数スケール
```typescript
// 対数スケール: log10(金額) に比例
height = log10(amount) * SCALE_FACTOR
```
- 長所: 広いレンジを圧縮できる
- 短所: 直感的でない（10倍の差が一定の高さ差になる）

#### 案2: 平方根スケール
```typescript
// 平方根スケール
height = sqrt(amount) * SCALE_FACTOR
```
- 長所: 対数より直感的
- 短所: まだ大きな金額に偏る

#### 案3: ズームレベル連動スケール
```typescript
// ズームに応じてスケールを変更
const scale = 1e-11 / Math.pow(2, zoom)
```
- 長所: ズームインすると小さな差も見える
- 短所: 実装が複雑、メンタルマップが崩れる可能性

### 現状維持の判断理由

1. **目的との整合性**: このツールの目的は「全体構造の理解」であり、詳細な金額比較ではない
2. **線形スケールの直感性**: 対数スケールは直感的でなく、ユーザーを混乱させる可能性
3. **メンタルマップ保持**: ズーム連動スケールは位置が変わり、認知負荷が増大
4. **大規模予算の可視化**: 主要な府省・局・事業の規模感は十分に伝わる

## 結論

100億円と1000億円のサイズ差が感じられないのは、**日本政府予算の金額レンジ（10桁）に対して線形スケールを採用しているため**であり、設計上正しい動作である。

このツールは「全体俯瞰」を目的としており、以下のトレードオフを受け入れている:

- **得られるもの**: 93兆円から数億円まで破綻なく描画できる
- **失うもの**: 閾値付近の小さな金額差の視覚的区別

詳細な金額比較が必要な場合は、InfoPanelのテーブル表示や、将来的な「詳細ビュー」機能で対応することが適切である。

## 関連設定

- デフォルト閾値: 100億円
- 閾値プリセット: 10億円〜1兆円（7段階）
- 高さスケール: 1兆円 = 10px
- 閾値以下ノード高さ: 1px
- 閾値以上ノード最小高さ: 5px
