# 動的LOD（Level of Detail）設計案

## 現状の問題

### 縦に長すぎる問題

現在のレイアウト:
- キャンバス高さ: 約3億px（`canvasHeight: 308,755,569`）
- 金額に完全比例した高さ: `height = amount * 0.000002`
- 結果: 画面に収まらず、ズームアウトすると線にしか見えない

### 根本原因

「金額に比例した高さ」を素直に実装すると:
- 厚生労働省: 93兆円 → 高さ約1.8億px
- 最小ノード: 数百万円 → 高さ1px

この差が大きすぎて、全体を俯瞰できない。

---

## 設計アイデア

### コンセプト: 「固定キャンバス + 動的スケール」

1. **キャンバス高さを固定**: 画面高さの2-3倍程度（例: 3000px）
2. **ズームレベルごとにスケールを変更**: 1pxあたりの金額が変化
3. **表示可能なノードのみ描画**: 1px未満のノードは非表示

### Google Mapsとの類似性

| Google Maps | Budget Flow Map |
|-------------|-----------------|
| 地球全体 → 国 → 都市 → 建物 | 全予算 → 府省 → 局 → 事業 |
| ズームで建物が現れる | ズームで事業が現れる |
| 道路の詳細度が変化 | エッジの表示数が変化 |
| 離散的なタイルレベル | 離散的なLODレベル |

---

## 具体的な設計

### キャンバスサイズ

```
固定キャンバス高さ = 3000px（仮）
```

### LODレベル定義

| Level | 名前 | 1pxあたりの金額 | 表示レイヤー | 表示ノード数目安 |
|-------|------|----------------|-------------|----------------|
| 0 | 俯瞰 | 1兆円 | Layer 0-1 | ~50 |
| 1 | 府省詳細 | 1000億円 | Layer 0-2 | ~200 |
| 2 | 局詳細 | 100億円 | Layer 0-3 | ~500 |
| 3 | 課詳細 | 10億円 | Layer 0-4 | ~2000 |
| 4 | 事業詳細 | 1億円 | 全レイヤー | ~5000 |

### ノード高さ計算

```typescript
// LODレベルに応じたスケール
const SCALE_PER_LEVEL = {
  0: 1e12,    // 1兆円/px
  1: 1e11,    // 1000億円/px
  2: 1e10,    // 100億円/px
  3: 1e9,     // 10億円/px
  4: 1e8,     // 1億円/px
}

function calculateNodeHeight(amount: number, lodLevel: number): number {
  const scale = SCALE_PER_LEVEL[lodLevel]
  const height = amount / scale

  if (height < 1) return 0  // 非表示
  return Math.max(1, height)  // 最小1px
}
```

### ズームレベルとLODの対応

```typescript
// deck.gl zoom → LOD level
function zoomToLodLevel(zoom: number): number {
  if (zoom < -2) return 0   // 俯瞰
  if (zoom < 0) return 1    // 府省詳細
  if (zoom < 2) return 2    // 局詳細
  if (zoom < 4) return 3    // 課詳細
  return 4                   // 事業詳細
}
```

---

## レイアウト再計算の必要性

### 問題: 事前計算されたY座標

現在は`layout.json`に事前計算されたY座標が含まれている。
LODレベルが変わると、ノードの高さが変わり、Y座標も再計算が必要。

### 解決策

**オプションA: クライアント側で動的計算**
- 各LODレベルでノードのY座標を再計算
- メリット: 柔軟性が高い
- デメリット: 計算コスト

**オプションB: 複数LOD用の座標を事前計算**
- `layout.json`に各LODレベルのY座標を含める
- メリット: 高速
- デメリット: ファイルサイズ増大

**オプションC: 相対位置で保存**
- Y座標を「親ノード内での相対位置」として保存
- LODレベルに応じてスケールを適用
- メリット: バランスが良い

### 推奨: オプションC（相対位置）

```typescript
interface LayoutNode {
  id: string
  // ... 既存フィールド

  // 新規: 相対位置（0-1の範囲）
  relativeY: number  // 親ノード内での相対位置

  // LOD計算用
  parentId: string | null
}

// 描画時にLODに応じてY座標を計算
function calculateY(node: LayoutNode, lodLevel: number, parentY: number, parentHeight: number): number {
  return parentY + node.relativeY * parentHeight
}
```

---

## 段階的な切り替えの視覚効果

### 問題: 急な切り替えは違和感

LODレベルが変わる瞬間、ノードが急に現れる/消えると違和感がある。

### 解決策: フェードイン/アウト

```typescript
// LODレベルの境界付近でフェード
function calculateOpacity(zoom: number, nodeMinLodLevel: number): number {
  const currentLod = zoomToLodLevel(zoom)

  if (currentLod < nodeMinLodLevel) return 0
  if (currentLod > nodeMinLodLevel) return 1

  // 境界付近: ズーム値に応じてフェード
  const lodBoundary = LOD_ZOOM_BOUNDARIES[nodeMinLodLevel]
  const fadeRange = 0.5  // ズーム0.5の範囲でフェード
  const fadeProgress = (zoom - lodBoundary) / fadeRange
  return Math.min(1, Math.max(0, fadeProgress))
}
```

---

## 実装ステップ

### Phase 1: 設計検証

1. データ分析: 各レイヤーの金額分布を確認
2. LODレベルの閾値を決定
3. キャンバスサイズを決定

### Phase 2: データパイプライン修正

1. `compute-layout.ts`を修正
2. 相対位置（relativeY）を計算
3. 各LODレベルでの表示可否を事前計算

### Phase 3: フロントエンド実装

1. `useLodLevel`フック作成（zoom → LOD変換）
2. `calculateNodePositions`関数（LODに応じた座標計算）
3. `useZoomVisibility`を拡張

### Phase 4: 視覚効果

1. フェードイン/アウト実装
2. ズームアニメーションの調整

---

## 検討事項

### Q: 府省庁間のバランス

現在は府省庁ごとに縦に並べているが、金額差が大きい:
- 厚生労働省: 93兆円
- デジタル庁: 数千億円

LODを適用すると、小さな府省庁が潰れてしまう可能性。

**対策案**:
- 府省庁は常に最小高さを保証（例: 50px）
- または、府省庁レベルでは対数スケールを使用

### Q: エッジの扱い

ノードのY座標が変わると、エッジのパスも変わる。

**対策**:
- エッジパスは描画時に動的計算（現在もそう）
- または、LODレベルごとにパスをキャッシュ

### Q: パフォーマンス

LODレベルが変わるたびに再計算が発生。

**対策**:
- useMemoで適切にキャッシュ
- LODレベルが変わるまでは再計算しない
- Web Workerでの計算を検討

---

## 次のアクション

1. [ ] 現在のデータで金額分布を分析
2. [ ] LODレベルの閾値を決定
3. [ ] 小規模なプロトタイプで検証
4. [ ] 設計をファイナライズ
5. [ ] 実装開始

---

## 現在のデータ統計（分析済み）

### 基本統計

```
ノード数: 30,799
エッジ数: 69,020
現在のキャンバス高さ: 308,755,569px（約3億px）
```

### レイヤー別統計

| Layer | 名前 | 件数 | 合計 | 最大 | 中央値 |
|-------|------|------|------|------|--------|
| 0 | 府省 | 37 | 151兆 | 93.3兆 | 331億 |
| 1 | 局 | 181 | 142兆 | 56.6兆 | 18億 |
| 2 | 課 | 1,102 | 147兆 | 56.1兆 | 1.6億 |
| 3 | 事業 | 5,664 | 147兆 | 30.0兆 | 0.1億 |
| 4 | 支出先 | 23,815 | 154兆 | 26.0兆 | ほぼ0 |

### Top5（全レイヤー）

1. 厚生労働省: 93.3兆円
2. 年金特別会計: 56.6兆円（局）
3. 年金給付課: 56.1兆円（課）
4. 国民年金勘定: 30.0兆円（事業）
5. 日本年金機構: 26.0兆円（支出先）

### 閾値別の表示ノード数

| 閾値 | 表示ノード数 | 特徴 |
|------|-------------|------|
| 10兆円以上 | 15件 | 超巨大ノードのみ |
| 5兆円以上 | 20件 | 主要省庁・局 |
| 1兆円以上 | 79件 | 俯瞰レベル |
| 5000億円以上 | 141件 | 府省詳細 |
| 1000億円以上 | 424件 | 局詳細 |
| 500億円以上 | 665件 | 課詳細 |
| 100億円以上 | 1,504件 | 事業俯瞰 |
| 50億円以上 | 2,098件 | 事業詳細 |
| 10億円以上 | 4,170件 | 全事業 |

---

## 分析からの洞察

### 1. 金額分布の偏り

- Top1（厚生労働省）が全体の約62%（93兆/151兆）
- 年金関連が圧倒的に大きい
- 中央値が非常に小さい（事業で0.1億円）

### 2. 適切なLODレベル案

分析結果から、以下の5段階が適切と考えられる:

| Level | 閾値 | 表示ノード数 | 用途 |
|-------|------|-------------|------|
| 0 | 5兆円 | ~20 | 超俯瞰（主要省庁のみ） |
| 1 | 1兆円 | ~80 | 俯瞰（全府省 + 主要局） |
| 2 | 1000億円 | ~400 | 詳細（局・課） |
| 3 | 100億円 | ~1500 | 事業俯瞰 |
| 4 | 10億円 | ~4000 | 全事業 |

### 3. キャンバス高さの計算

**目標**: 画面高さの3倍程度（約3000px）

Top1（93兆円）を1000pxで表示する場合:
- 1px = 930億円
- 全体（151兆円）≒ 1624px
- 府省庁間の間隔を含めて約2000-3000px

これは適切なサイズ。
