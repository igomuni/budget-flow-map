# ロードマップ

作成日: 2024-12-26
最終更新: 2024-12-28 (21:00)

## 現在の状態

### 実装済み機能

#### コア機能
- [x] 5層Sankey DAG構造（府省→局→課→事業→支出先）
- [x] deck.gl による大規模グラフレンダリング（PolygonLayer + PathLayer）
- [x] Bezier曲線エッジ描画
- [x] ズーム連動表示（Google Maps式、PR #22）
- [x] ~~動的TopNフィルタリング~~ → ズーム連動表示に置換
- [x] ~~「その他」ノードへの集約~~ → 廃止（全ノード個別表示）
- [x] 支出先ノードの重複解消（法人番号ベースで統合、複数府省庁表示対応）

#### インタラクション
- [x] ホバー: BFS探索で先祖・子孫すべてをハイライト
- [x] クリック: 選択状態 + 左パネル詳細表示
- [x] ズーム/パン: マウスホイール + ドラッグ
- [x] ミニマップ: 全体の位置把握

#### レイアウト
- [x] 府省庁ごとのグループ化
- [x] レイヤーTop位置揃え
- [x] 課レイヤーの局位置順配置
- [x] 局なし課への対応（公安調査庁等）
- [x] 縦横間隔調整（0pxで隙間なし対応）

#### UI
- [x] ~~TopN設定ダイアログ~~ → 廃止（ズーム連動表示に置換）
- [x] レイヤー可視性インジケーター（設定パネル内）
- [x] 間隔調整コントロール
- [x] ズームコントロール
- [x] ツールチップ
- [x] サイドパネル折りたたみ/展開（エッジスタイルボタン）
- [x] テキスト省略を折り返し表示に変更（タイトル、支出先、事業一覧）

#### 検索機能 (Phase 2.1 完了)
- [x] ノード名検索（インクリメンタル）
- [x] 検索結果からノードへジャンプ（クリック選択 + ビューポート移動）
- [x] キーボードナビゲーション（↑↓選択、Enter決定、Esc閉じる）
- [x] ⌘K / Ctrl+K でフォーカス
- [x] 検索履歴（最近の10件）
- [x] IME入力対応（日本語変換中のキー操作無視）

#### 左パネル (Phase 2.3 + UX改善 完了)
- [x] タブ切替実装（基本情報/支出先/フロー）
- [x] 支出先タブ: 関連支出先一覧、金額・構成比表示、全体順位表示
- [x] 事業タブ: 支出先ノード選択時に関連事業一覧表示
- [x] 基本情報タブ: ノード種別に応じた詳細情報
  - 支出先: 受取総額、法人番号、種別、所在地、支出元府省
  - 事業: 予算額、執行率（プログレスバー付き）、所管府省
  - 組織: 予算総額、所管府省
- [x] 階層パス表示（府省→局→課→事業）
- [x] 「その他の支出先」を府省庁横断の単一ノードに変更
- [x] フローティング検索ボックス + 条件付きパネル表示（PR #19）
- [x] 折りたたみ/展開機能（Google Maps式、Zustand状態管理）
- [x] 初期表示で全体をフィット（アニメーション付き）
- [x] テキスト折り返し表示（truncateから break-words へ）

---

## Phase 2: UX改善

### 2.1 検索機能 ✅ 完了
- [x] ノード名検索（インクリメンタル）
- [x] 検索結果からノードへジャンプ
- [x] 検索ヒット時のハイライト

### 2.2 URL状態同期・共有機能 ✅ 完了
- [x] 選択ノードのURL保存（PR #15, #17）
  - Google Maps式 path-based URL: `/node/<id>/<name>`
  - 初期ロード時の自動選択・ズーム
  - 共有リンクボタン（クリップボードコピー）
  - zoomチャタリング問題を解決（viewStateRef導入）
- [ ] ~~ズーム/パン位置のURL保存~~ (設計判断により非実装)
- [ ] ~~TopN設定のURL保存~~ (設計判断により非実装)

### 2.3 左パネル改善 ✅ 完了
- [x] タブ切替実装（基本情報/支出先/フロー）
- [x] 関連支出先リスト表示
- [x] 関連事業リスト表示（支出先ノード用）
- [x] 金額詳細表示
- [x] フローティング検索ボックス（PR #19）
- [x] 条件付きパネル表示（検索時・選択時のみ表示）
- [x] 折りたたみ/展開機能（Zustand状態管理）
- [x] テキスト折り返し表示（タイトル、支出先、事業一覧）

### 2.4 ラベル表示改善 ⏸️ 保留
- [ ] ズームレベル連動ラベル表示（deck.gl TextLayer座標系の問題で保留）
  - 俯瞰（1x）: 府省名のみ
  - 中間（2-4x）: 局名まで
  - 詳細（5x+）: 事業名まで
- [ ] ラベル衝突回避

### 2.5 フロータブ実装 ✅ 完了
- [x] 上流ノード一覧（予算元）
- [x] 下流ノード一覧（支出先）
- [ ] フローパスの可視化（将来検討）

---

## Phase 3: パフォーマンス最適化

### 3.1 レンダリング最適化 ✅ 一部完了
- [x] Viewport外ノード/エッジのカリング（PR #11）
  - viewportCulling.ts: 境界計算 + カリング関数
  - 100msデバウンスでチャタリング防止
  - 50%パディングでスムーズな遷移
  - ミニマップドラッグ時の即時応答
- [ ] レイヤーキャッシング

### 3.2 ズーム連動LOD 🚧 設計中
- [ ] TopNからズーム連動閾値集約への移行
  - 詳細: [20251228_1300_zoom-based-lod-design.md](./20251228_1300_zoom-based-lod-design.md)
  - 目標: ズームレベルに応じて表示詳細度が動的に変化
- [ ] `useDynamicLOD` フック実装
- [ ] 閾値ベース集約ロジック
- [ ] ズーム連動閾値計算
- [ ] 視覚的連続性（メンタルマップ保持）

### 3.3 データ最適化
- [ ] 遅延ロード検討（必要に応じて）
- [ ] Web Worker でのBFS計算

---

## Phase 4: 機能拡張

### 4.1 複数年度対応
- [ ] 年度切替UI
- [ ] 年度間比較表示（差分ハイライト）

### 4.2 エクスポート・UI設定 ✅ 完了
- [x] 選択ノードのCSVエクスポート（PR #12）
  - exportCsv.ts: ノード情報と上流/下流をCSV出力
  - SidePanelヘッダーにダウンロードボタン
  - BOM付きUTF-8でExcel互換
- [x] ~~スクリーンショット生成~~ → OS標準機能で十分のため不要
- [x] TopN設定の別ダイアログ化（PR #20）
  - Apply/Cancel方式で即時再レンダリングを回避
  - TopNSettingsDialog.tsx: 独立したモーダルダイアログ
  - パフォーマンス警告メッセージ表示

### 4.3 埋め込み対応 ✅ 一部完了
- [ ] iframe埋め込み用軽量版
- [x] 特定ノードへの直リンク（PR #15, #17）
  - urlState.ts: URL状態管理ユーティリティ
  - パス形式URL: `/node/<id>/<name>`（Google Maps式）
  - 共有ボタン: URLをクリップボードにコピー
  - 初回ロード時にURLからノード復元・自動ズーム
  - vercel.json: SPA routing設定
  - zoomチャタリング問題を解決（viewStateRef導入）

---

## Phase 5: 運用・保守

### 5.1 データ更新パイプライン
- [ ] 新年度データ取り込み自動化
- [ ] データ検証スクリプト

### 5.2 モニタリング
- [ ] パフォーマンスメトリクス収集
- [ ] エラートラッキング

### 5.3 デプロイ ✅ 完了
- [x] Vercelデプロイ設定
- [x] CI/CDセットアップ（GitHub Actions）
- [x] Lintエラー修正

---

## 優先度マトリクス（更新版）

| 機能 | 影響度 | 実装難度 | 状態 | 優先度 |
|------|--------|----------|------|--------|
| 検索機能 | 高 | 中 | ✅ 完了 | - |
| 左パネルタブ | 中 | 低 | ✅ 完了 | - |
| フロータブ実装 | 中 | 低 | ✅ 完了 | - |
| **ズーム連動LOD** | **高** | **高** | **🚧 設計中** | **高** |
| ズーム連動ラベル | 中 | 中 | ⏸️ 保留 | - |
| Viewportカリング | 中 | 高 | ✅ 完了 | - |
| 複数年度対応 | 低 | 高 | 🚧 未着手 | 低 |

---

## 技術的負債

- [x] ~~InfoPanel未実装~~ → 完了（SidePanel.tsx + 各タブコンポーネント）
- [x] ~~FlowContextTab未実装~~ → 完了（PR #9）
- [ ] テストコード未整備
- [ ] エラーハンドリング強化
- [ ] アクセシビリティ対応

---

## 最近の主要な変更

| PR/コミット | 内容 |
|-------------|------|
| #22 | ズーム連動表示 - TopNからGoogle Maps式シームレス体験へ移行 |
| #20 | ~~TopN設定を別ダイアログに分離~~ → #22で廃止 |
| #19 | サイドパネルUX改善 - フローティング検索、折りたたみ機能、テキスト折り返し |
| #17 | zoomチャタリング修正 - viewStateRef導入で無限ループ解消 |
| #15 | 特定ノードへの直リンク - URL共有機能（Google Maps式） |
| #12 | CSVエクスポート機能 - 選択ノード詳細をダウンロード |
| #11 | Viewportカリング + ミニマップ即時応答 |
| #9 | フロータブ実装 - 上流・下流ノード一覧表示 |
| #8 | 階層パス表示をタイトル下に統一、種別ラベル改善 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-28 | ズーム連動LOD設計を追加（Phase 3.2）- TopNから閾値集約への移行計画 |
| 2024-12-28 21:00 | ズーム連動表示 - TopNからGoogle Maps式へ移行（PR #22） |
| 2024-12-28 19:00 | Phase 2.3/4.2 追加完了 - サイドパネルUX改善（PR #19, #20） |
| 2024-12-28 | Phase 2.2 完了 - zoomチャタリング修正（PR #17） |
| 2024-12-27 | Phase 4.3 特定ノードへの直リンク完了（PR #15） |
| 2024-12-27 | Phase 4.2 エクスポート機能完了（PR #12） |
| 2024-12-27 | Phase 3.1 Viewportカリング完了（PR #11） |
| 2024-12-27 | Phase 2.5完了、2.4保留、Phase 3開始 |
| 2024-12-27 | Phase 2.1/2.3完了を反映、最近の変更を追加 |
| 2024-12-26 | 初版作成 |
