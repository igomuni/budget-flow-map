# 支出先データの金額分布分析

## 分析日
2026-01-04

## 概要

支出先ノード（Layer 4）の金額分布を分析し、最適なズーム範囲を検討する。

## 基本統計

| 指標 | 値 |
|------|-----|
| 総数 | 23,815件 |
| 最小値 | 30円 |
| 最大値 | 約26兆円 |
| 平均値 | 64.8億円 |
| **中央値** | **1,357万円** |

## パーセンタイル

| パーセンタイル | 金額 |
|---------------|------|
| 1% | 1.7万円 |
| 5% | 11.9万円 |
| 10% | 39万円 |
| 25% | 230万円 |
| **50%（中央値）** | **1,357万円** |
| 75% | 9,588万円 |
| 90% | 6.1億円 |
| 95% | 19.8億円 |
| 99% | 319億円 |

## 金額帯別分布

```
金額帯                件数      割合
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0〜100円                  1件    0.0%
100円〜1万円            148件    0.6%
1万〜100万円          3,929件   16.5%  ████████
100万〜1000万円        6,739件   28.3%  ██████████████
1000万〜1億円          7,140件   30.0%  ███████████████  ← 最頻値帯
1億〜10億円            4,099件   17.2%  █████████
10億〜100億円          1,313件    5.5%  ███
100億〜1000億円          335件    1.4%  █
1000億〜1兆円             96件    0.4%
1兆円以上                 15件    0.1%
```

**モード（最頻値帯）: 1000万〜1億円**

## 閾値とカバー率

| 閾値 | 展開ノード数 | カバー率 | 必要zoom |
|------|-------------|----------|----------|
| 1兆円 | 15件 | 0.06% | 0 |
| 1000億円 | 111件 | 0.47% | 1.66 |
| 100億円 | 446件 | 1.87% | 3.32 |
| 10億円 | 1,759件 | 7.39% | 4.98 |
| **1億円** | **5,858件** | **24.6%** | **6.64** |
| **1000万円** | **12,998件** | **54.6%** | **8.30** |
| 100万円 | 19,737件 | 82.9% | 9.97 |

※必要zoom = log₄(1兆円 ÷ 閾値)

## 現状の設定

| 項目 | 値 |
|------|-----|
| minZoom | -4（6.25%） |
| maxZoom | 6（6400%） |
| maxZoom時の閾値 | 約2.4億円 |
| maxZoom時のカバー率 | 約25% |

## 推奨設定

### maxZoom = 8（25,600%）
- 閾値: 約1,500万円
- カバー率: 約50%（中央値付近）
- 展開ノード数: 約12,000件

### maxZoom = 9（51,200%）
- 閾値: 約380万円
- カバー率: 約70%
- 展開ノード数: 約17,000件

## 考察

1. **現状の問題**: maxZoom=6では中央値（1,357万円）に到達できない
2. **推奨**: maxZoom=8〜9に拡大することで、分布の中央付近まで探索可能
3. **パフォーマンス**: 1万件超のノード描画はdeck.glで問題なく処理可能

## ズームレベル早見表

| zoom | 倍率 | 閾値 | 展開数（概算） |
|------|------|------|---------------|
| 0 | 100% | 1兆円 | 15件 |
| 2 | 400% | 625億円 | 200件 |
| 4 | 1,600% | 39億円 | 1,000件 |
| 6 | 6,400% | 2.4億円 | 5,000件 |
| 8 | 25,600% | 1,500万円 | 12,000件 |
| 9 | 51,200% | 380万円 | 17,000件 |

## 関連ファイル

- `src/components/BudgetFlowMap.tsx` - minZoom/maxZoom定義
- `src/hooks/useZoomVisibility.ts` - 閾値計算ロジック
- `docs/20251230_0030_height-scale-analysis.md` - 高さスケール分析

## CSVデータとの比較

### データソースの違い

| 項目 | CSV（個別契約） | layout.json（支出先集約） |
|------|----------------|-------------------------|
| **レコード数** | 96,900件 | 23,815件 |
| **最小値** | 20円 | 30円 |
| **最大値** | 約24.7兆円 | 約26兆円 |
| **平均値** | 16億円 | 64.8億円 |
| **中央値** | **804万円** | **1,357万円** |

### CSV（個別契約単位）の金額帯別分布

```
金額帯                件数      割合
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0〜100円                  3件    0.0%
100円〜1万円            1,433件    1.5%
1万〜100万円           23,627件   24.4%  ████████████
100万〜1000万円         26,567件   27.4%  █████████████
1000万〜1億円           27,338件   28.2%  ██████████████  ← 最頻値帯
1億〜10億円             13,059件   13.5%  ██████
10億〜100億円            3,914件    4.0%  ██
100億〜1000億円            816件    0.8%
1000億〜1兆円              127件    0.1%
1兆円以上                   16件    0.0%
```

### CSVパーセンタイル

| パーセンタイル | 金額 |
|---------------|------|
| 1% | 6,000円 |
| 5% | 4.7万円 |
| 10% | 14.7万円 |
| 25% | 98.4万円 |
| **50%（中央値）** | **804万円** |
| 75% | 5,225万円 |
| 90% | 3.2億円 |
| 95% | 10億円 |
| 99% | 99億円 |

### 集約の影響

1. **レコード数の減少**: 96,900件 → 23,815件（約4倍の契約が1支出先に集約）
2. **中央値の上昇**: 804万円 → 1,357万円（集約により金額が積み上がる）
3. **モード帯は同一**: 両方とも「1000万〜1億円」が最頻値帯（約28-30%）
4. **分布形状の保持**: 集約しても分布の形状は大きく変わらない

### 結論

- **モード帯（最頻値帯）は安定**: CSV・集約後ともに1000万〜1億円
- **maxZoom=8の妥当性**: 閾値≈1500万円で中央値付近をカバー
- **集約による情報損失**: 個別契約の詳細は失われるが、分布の傾向は維持

## 次のアクション

1. maxZoomを8または9に変更
2. パフォーマンステスト実施
3. 必要に応じてビューポートカリングを有効化
