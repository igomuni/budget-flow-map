# CI/CD セットアップガイド

## CI/CD構成

### GitHub Actions ワークフロー

`.github/workflows/ci.yml` で以下のジョブを実行:

1. **lint-and-typecheck**: ESLintとTypeScript型チェック
2. **build**: プロダクションビルド
3. **data-pipeline-check**: データパイプライン検証（オプション）

### CD（継続的デプロイ）

- **Vercel**: mainブランチへのpush/merge時に自動デプロイ
- プレビュー: Pull Request作成時に自動でプレビュー環境デプロイ

---

## GitHub Branch Protection（Rulesets）設定手順

### 1. Rulesets作成

1. https://github.com/igomuni/budget-flow-map/settings/rules にアクセス
2. **New ruleset** → **New branch ruleset** をクリック

### 2. 基本設定

```yaml
Ruleset Name: Protect main branch
Enforcement status: Active
Target branches: main
```

### 3. 推奨ルール設定

#### ✅ 必須設定

- **Require a pull request before merging**
  - Require approvals: 1（自分でレビュー）
  - Dismiss stale pull request approvals when new commits are pushed: ON
  - Allow specified actors to bypass required pull requests: 自分のアカウントを追加（緊急時用）

- **Require status checks to pass**
  - Require branches to be up to date before merging: ON
  - Status checks that are required:
    - `lint-and-typecheck`
    - `build`
    - （オプション）`data-pipeline-check` - データパイプライン変更時のみ必要

- **Require signed commits**: ON（後述の署名設定が必要）

- **Block force pushes**: ON

- **Restrict deletions**: ON

#### ⚠️ オプション設定

- **Require linear history**: ON（推奨 - クリーンな履歴維持）
- **Require deployments to succeed**: ON（Vercelデプロイ成功確認）

---

## 署名付きコミット（Signed Commits）設定

### 前提条件

GPGキーまたはSSHキーで署名可能。ここではSSHキーを使用する方法を推奨。

### 1. SSH署名鍵の設定（推奨）

#### 既存のSSH鍵を確認

```bash
ls -la ~/.ssh
# id_ed25519.pub が存在するか確認
```

#### 新規作成（必要な場合）

```bash
ssh-keygen -t ed25519 -C "igomuni1562@gmail.com"
# Enterキー連打でデフォルト設定
```

#### GitHubに公開鍵を登録

```bash
# 公開鍵をコピー
cat ~/.ssh/id_ed25519.pub | pbcopy

# または表示してコピー
cat ~/.ssh/id_ed25519.pub
```

1. https://github.com/settings/keys にアクセス
2. **New SSH key** → **Authentication Key** として追加
3. 同じ鍵で **Signing Key** も追加
   - **New SSH key** → Key type: **Signing Key** を選択
   - 同じ公開鍵を貼り付け

### 2. Gitの署名設定

```bash
# SSH署名を有効化
git config --global gpg.format ssh

# 署名用の鍵を指定
git config --global user.signingkey ~/.ssh/id_ed25519.pub

# すべてのコミットに署名
git config --global commit.gpgsign true

# タグにも署名
git config --global tag.gpgsign true
```

### 3. 設定確認

```bash
# 設定を表示
git config --global --list | grep -E 'gpg|sign'

# 出力例:
# gpg.format=ssh
# user.signingkey=/Users/igomuni/.ssh/id_ed25519.pub
# commit.gpgsign=true
# tag.gpgsign=true
```

### 4. 署名付きコミットのテスト

```bash
# テストコミット
git commit --allow-empty -m "test: verify signed commit"

# 署名を確認
git log --show-signature -1

# 出力に "Good signature" が表示されればOK
```

### 5. Claude Codeの署名設定

Claude Codeでコミット作成時も自動で署名されます（上記のglobal設定が適用）。

---

## トラブルシューティング

### CI/CD関連

#### `data-pipeline-check` が失敗する場合

marumie-rssystemリポジトリがprivateの場合、Personal Access Tokenが必要:

1. https://github.com/settings/tokens で Fine-grained tokenを作成
2. Repository access: `igomuni/marumie-rssystem` のみ
3. Permissions: `Contents` → Read-only
4. リポジトリのSecrets設定: `MARUMIE_RSSYSTEM_TOKEN` に追加
5. `.github/workflows/ci.yml` の該当行のコメントを解除

#### データパイプラインチェックをスキップしたい場合

`.github/workflows/ci.yml` から `data-pipeline-check` ジョブを削除。

### 署名付きコミット関連

#### "gpg failed to sign the data" エラー

```bash
# SSH署名設定を再確認
git config --global gpg.format ssh
git config --global user.signingkey ~/.ssh/id_ed25519.pub
```

#### GitHubで "Unverified" と表示される

- GitHubにSigning Keyとして登録されているか確認
- `user.email` がGitHubアカウントと一致しているか確認

```bash
git config --global user.email
# → igomuni1562@gmail.com であることを確認
```

---

## CI/CDステータスバッジ

README.mdに追加（オプション）:

```markdown
[![CI](https://github.com/igomuni/budget-flow-map/actions/workflows/ci.yml/badge.svg)](https://github.com/igomuni/budget-flow-map/actions/workflows/ci.yml)
```

---

## 開発フロー（Rulesets適用後）

### 通常の変更

1. フィーチャーブランチ作成
   ```bash
   git checkout -b feature/new-feature
   ```

2. 変更とコミット（自動署名）
   ```bash
   git add .
   git commit -m "feat: add new feature"
   ```

3. プッシュ
   ```bash
   git push -u origin feature/new-feature
   ```

4. Pull Request作成
   - GitHub UIまたは `gh pr create`
   - CI/CDが自動実行

5. マージ
   - CI/CD成功後、GitHub UIでマージ
   - Squash mergeを推奨

### 緊急時（Bypass Pull Request）

Rulesetsで自分のアカウントをBypass actorsに追加している場合:

```bash
git checkout main
git pull
# 緊急修正
git commit -m "fix: urgent hotfix"
git push origin main
```

ただし、通常はPRを経由することを推奨。

---

## 日付

2025-12-26
