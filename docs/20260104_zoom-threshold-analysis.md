# ズーム閾値と全ノード展開の分析

## 現状

最大ズーム6368%（zoom≈6）で「その他」に集約されているノードが19949件残っている。

## データ分析結果

### 支出先ノード（Layer 4）の金額分布

| 金額範囲 | 件数 | 割合 |
|----------|------|------|
| 0円 | 0件 | 0% |
| 0円超〜1億円未満 | 17,957件 | 75.4% |
| 1億円〜2.44億円未満 | 1,970件 | 8.3% |
| 2.44億円以上 | 3,888件 | 16.3% |
| **合計** | **23,815件** | 100% |

- 最小金額: 30円
- 2.44億円未満: 19,927件（最大ズームでも「その他」に残る）

### ズームレベル別閾値

| zoom | 倍率 | 閾値 | 累計表示件数（推定） |
|------|------|------|---------------------|
| 0 | 100% | 1兆円 | 極少数 |
| 1 | 200% | 2,500億円 | 少数 |
| 2 | 400% | 625億円 | 数百 |
| 3 | 800% | 156億円 | 数百 |
| 4 | 1,600% | 39億円 | 数千 |
| 5 | 3,200% | 9.77億円 | 数千 |
| **6** | **6,400%** | **2.44億円** | **3,888件** |
| 7 | 12,800% | 0.61億円 | 〜6,000件 |
| 8 | 25,600% | 0.15億円 | 〜12,000件 |
| 9 | 51,200% | 0.04億円 | 〜20,000件 |
| 10 | 102,400% | 0.01億円 | 〜23,000件 |
| 11 | 204,800% | 24万円 | ほぼ全件 |
| **12** | **409,600%** | **6万円** | **全件（30円以上）** |

### 全ノード展開に必要なズーム

```
最小金額: 30円
必要な閾値: 30円以下
必要なzoom: log4(1兆円 / 30円) = log4(3.33×10^10) ≈ 17.5
必要な倍率: 2^17.5 × 100% ≈ 18,500,000%（1850万%）
```

## 問題点

1. **現実的でないズーム倍率**
   - 全ノード展開には1850万%のズームが必要
   - 現在のmaxZoom=6（6400%）では約20,000件が「その他」に残る

2. **ノード数の爆発**
   - 全23,815件を同時描画するとパフォーマンス問題
   - 特に1億円未満の17,957件は金額が小さく視覚的に意味が薄い

3. **高さの問題**
   - 30円のノードの高さ: 30 × 1e-11 = 3e-10 px（実質0px）
   - 1億円未満のノードはすべて視認不可能なサイズ

## 設計方針の選択肢

### 案1: 現状維持（推奨）

- maxZoom=6のまま、約20,000件は常に「その他」に集約
- **理由**:
  - 1億円未満のノードは高さが実質0pxで視認できない
  - 全体俯瞰が目的であり、30円の支出先を見る必要はない
  - パフォーマンスを維持

### 案2: 段階的展開の上限を設定

```typescript
// 最小閾値を1億円に固定
const MIN_THRESHOLD = 1e8; // 1億円
function getMinVisibleAmount(layer, zoom) {
  const baseThreshold = 1e12;
  const dynamicThreshold = baseThreshold / Math.pow(4, zoom);
  return Math.max(MIN_THRESHOLD, dynamicThreshold);
}
```

- zoom≈5.3（約4000%）で閾値が1億円に達し、それ以上はズームしても展開されない
- 約5,858件が表示可能、17,957件は常に「その他」

### 案3: 件数ベースの上限

```typescript
// 各レイヤーで最大N件まで表示
const MAX_VISIBLE_NODES = 5000;
// 金額上位5000件を表示、残りは「その他」
```

### 案4: 高さベースの下限

```typescript
// 高さが1px未満になるノードは表示しない
const MIN_DISPLAYABLE_HEIGHT = 1;
// 1px = 1000億円 なので、1000億円未満は自動的に「その他」
```

## 推奨: 案1（現状維持）+ UIの改善

### 理由

1. **視覚化の本質**
   - 30円や100万円の支出先を地図上で見る意味がない
   - 高さが0.00001pxでは視認不可能

2. **パフォーマンス**
   - 23,815件を同時描画は重い
   - 現状の約4,000件が適切

3. **ユーザーニーズ**
   - 小額支出先はInfoPanelの一覧で確認すれば十分
   - 「その他(19949件)」をクリックすると一覧表示

### UIの改善案

1. **「その他」ノードの詳細表示**
   - クリックでInfoPanelに内訳一覧を表示
   - 金額順にソートして閲覧可能に

2. **ツールチップの改善**
   - 「その他」ホバー時に「〇〇件、合計△△億円」を表示
   - 「ズームインで一部展開可能」のヒント

3. **レイヤーインジケーターの改善**
   - 「支出先: 3,888件表示中 / 23,815件」のような表示

## 次のステップ

1. [ ] 「その他」ノードのInfoPanel詳細表示を実装
2. [ ] 現在の表示件数/総件数のインジケーター追加
3. [ ] ドキュメント（CLAUDE.md）に設計判断を記載
