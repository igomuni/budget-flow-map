# budget-flow-map 仕様書（日本語版）

## 1. 概要

**budget-flow-map** は、日本政府の RSシステム（行政事業レビュー）に由来するCSVデータをもとに、
政府予算と支出の流れを **「地図のように探索できる構造」** として可視化するWebアプリケーションである。

本プロジェクトは、従来の
- ドリルダウン型UI
- Top-N による情報削減
に依存した可視化を採らず、

**全体構造を一度に提示したうえで、ズーム・パン操作によって理解を深める**
というアプローチを中核に据える。

---

## 2. 背景と課題認識

### 2.1 課題

政府予算・支出データの可視化には、以下の構造的問題がある。

- 事業数・支出先数が多く、Sankey図が破綻しやすい
- Top-N表示では「残り」が不可視化され、全体像を誤認する
- ドリルダウン前提のUIは、構造理解より操作理解を要求する
- 一度詳細に入ると、元の文脈に戻りにくい

これらはすべて、「情報量が多い」ことではなく、
**可視化モデルとインタラクション設計の不整合**に起因している。

---

## 3. 先行実装・参考事例

### 3.1 既存リポジトリ

- 旧リポジトリ
  https://github.com/igomuni/marumie-rssystem

特徴：
- Nivo Sankey を利用
- Top-N + ドリルダウン構成
- 技術検証としては有効だったが、俯瞰性と拡張性に限界があった

本プロジェクトは、これを **思想的・技術的な前段階**として位置づける。

### 3.2 デザイン・情報設計の参考

- 米国エネルギー省（DOE）公式サイト
  http://www.departmentof.energy/

参考点：
- 落ち着いた情報階層
- 強調しすぎない色彩設計
- 明示的なドリルダウンに依らない段階的理解

---

## 4. 設計思想（Design Principles）

### 4.1 ドリルダウンの原則廃止

- 情報は一つの連続した空間に存在する
- 「クリックして次へ進む」構造を作らない

### 4.2 地図的インタラクション

- ズーム：解像度が変わる（意味的変化を伴う）
- パン：隣接構造の探索
- フォーカス：文脈を失わず注目点を強調

Google Maps に近い認知モデルを採用する。

### 4.3 構造優先・詳細後置

- 最初に見るのは「形・流れ・密度」
- ラベルや数値は必要なときにのみ現れる

### 4.4 スケーラビリティ前提

- 数千〜数万ノードを例外ではなく前提とする
- 小規模データ向け最適化は行わない

### 4.5 集約・クラスタリングの禁止

- すべてのノードは個別に描画される
- TopNフィルタリングは厳禁

---

## 5. データモデル

### 5.1 入力データ

- RSシステム由来CSV（令和6年度）
- 主な要素：
  - 予算区分
  - 事業
  - 支出先
  - 金額
  - 年度

### 5.2 グラフ構造（5層 Sankey DAG）

```
[府省] → [局] → [課] → [事業] → [支出先]
   ↓       ↓       ↓       ↓
 Layer0  Layer1  Layer2  Layer3   Layer4
```

- 全5層が独立したノードとして描画される
- エッジは隣接層間のみ（府省→局、局→課、課→事業、事業→支出先）
- 支出先は事業からのエッジの終点として表現

### 5.3 内部表現

- 有向重み付きグラフ（DAGに近い構造）
- ノード：
  - `id`
  - `type`（府省 / 局 / 課 / 事業 / 支出先）
  - `amount`
  - `layer`（0-4）
- エッジ：
  - `source`
  - `target`
  - `value`

事前集約・クラスタリングは**許可しない**。
すべての構成要素を個別に保持し、描画する。

---

## 6. 可視化アーキテクチャ

### 6.1 レンダリング戦略

| レイヤ | 技術 | 役割 |
|------|------|------|
| 基本描画 | WebGL / Canvas | 大量ノード・エッジ描画 |
| インタラクション | SVG / HTML Overlay | ホバー、フォーカス、ラベル |
| UI | React | 状態管理・レイアウト |

### 6.2 レイアウト方針

- **ビルド時事前計算**：レイアウト位置はビルド時に計算し、JSONとして保存
- クライアント側はレンダリングのみを担当
- Sankey的な左右配置の Flow-aware レイアウト
- 重視点：
  - 流れの連続性
  - 層ごとの水平方向配置
  - 密度そのものを情報として扱う

操作によってレイアウトが大きく変わらない
**メンタルマップ保持**を必須条件とする。

### 6.3 スケール要件

- **ノード数**：1万〜3万
- **エッジ数**：数万
- **目標フレームレート**：ズーム・パン操作時に60fps

---

## 7. 視覚言語

### 7.1 ノードデザイン

**色設計（ハイブリッド方式）**：
- 基本色相：府省カテゴリで決定（例：厚労省=青系、国交省=緑系）
- 彩度：ノードタイプで変化（府省=高彩度、課=中彩度、事業=低彩度）
- 明度：金額規模で変化（大=明るい、小=暗い）

**サイズ**：
- 予算/支出金額に比例（線形スケール）
- 視認性を保証するための最小サイズ閾値を設定

### 7.2 エッジデザイン

- **太さ**：金額に線形比例
- **色**：上流ノード（府省）の色を継承
- **形状**：Sankey的なベジェ曲線（水平方向の流れを強調）
- **透明度**：
  - 通常時：30%
  - ホバー関連：100%
  - 非関連：10%

### 7.3 ラベル表示（ズーム連動型）

| ズームレベル | 表示内容 | ラベル |
|-------------|----------|--------|
| 俯瞰（1x） | 全体構造、府省レベルのノードが主 | 府省名のみ |
| 中間（2-4x） | 局・課レベルが識別可能に | 局名まで表示 |
| 詳細（5x+） | 事業レベルまで個別識別 | 事業名表示 |

- ズームは連続的（離散段階ではない）
- ラベルはズームレベルに応じて段階的に出現

---

## 8. インタラクション設計

### 8.1 必須

**ホバー**：
- 直接接続のエッジのみハイライト
- ホバーノードの詳細情報をツールチップで表示

**クリック（Google Maps式）**：
- 左側パネルに詳細情報を表示
- タブ切り替え：基本情報 / 関連支出先リスト / フローコンテキスト
- ビューポートは変化しない（ドリルダウンなし）

**ズーム/パン**：
- マウスホイールでズーム
- ドラッグでパン
- ダブルクリックでズームイン（任意実装）

### 8.2 任意

- 検索・位置特定
- 年度切り替え（将来：複数年度対応）

### 8.3 明示的に行わないこと

- ステップ型ドリルダウン
- モーダル多用
- ページ分割型探索
- TopNフィルタリング
- 視覚的集約・クラスタリング

---

## 9. 技術スタック

### 9.1 フロントエンド

- React
- TypeScript
- Zustand（軽量ステート管理）

### 9.2 可視化（候補）

- **主要**：deck.gl（ScatterplotLayer + PathLayer）または PixiJS
- **レイアウト計算**：d3-sankey または dagre（ビルド時のみ）
- **オーバーレイ**：ラベル・ツールチップ用のDOM/SVG

※ Nivo は採用しない。

### 9.3 ビルドパイプライン

- Vite
- ESLint / Prettier
- ビルド時レイアウト計算（Node.js スクリプト）
- CSV ストリーミングパース対応

---

## 10. 非目標（Non-Goals）

- 会計実務向けUI
- モバイル最適化（タブレットまで）
- ストーリーテリング主導の解説UI
- 複数年度対応（初回リリースでは令和6年度のみ）

---

## 11. 判断保留事項

以下は初回実装後に反復的に決定する：

| 項目 | 優先度 | 理由 |
|------|--------|------|
| 検索機能の詳細 | 中 | 基本機能完成後に追加可能 |
| 金額ゼロ項目の扱い | 中 | 実データでの検証が必要 |
| 初期ビューポート設計 | 中 | プロトタイプでの検証が必要 |
| アクセシビリティ要件 | 低 | 段階的に対応可能 |
| 印刷・静的出力 | 低 | スコープ外 |
| 複数年度対応 | 低 | 将来拡張 |

---

## 12. プロジェクト哲学

本プロジェクトは、
政府予算を「読むもの」ではなく
**「歩き回って把握する構造」**として扱う。

理解は、操作手順ではなく
空間的な慣れによって生まれる。

**「操作して理解する」のではなく「眺めて慣れることで理解する」**
可視化を目指す。

---

## 13. アーキテクチャ制約

1. **TopN禁止** — すべてのノードを個別に描画すること
2. **ドリルダウン禁止** — クリックで情報パネルを表示、ビューは変化させない
3. **パフォーマンス最優先** — 60fpsが最低許容フレームレート
4. **伝統的Sankey流** — 左から右への方向性を維持
5. **ビルド時レイアウト** — クライアントは事前計算された位置のレンダリングのみ
